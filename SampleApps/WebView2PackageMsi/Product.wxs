<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="WebView2SampleApp" Language="1033" Version="1.0.0.0" Manufacturer="Microsoft Corp." UpgradeCode="3bf3b84c-e140-4276-81bd-23f461b01f71">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser"/>
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."/>
    <MediaTemplate EmbedCab="yes"/>

    <!-- Precondition: Check whether WebView RunTime already installed or not -->
    <Property Id="WVRTINSTALLED">
      <RegistrySearch Id="WVRTInstalled" Root="HKLM" Key="SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\ClientState\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}" Name="EBWebView" Type="raw"/>
    </Property>
    
    <!--[Custom UI] Let User choose install location-->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER"/>
    <UIRef Id="WixUI_InstallDir"/>

    <!-- Step 1: Define installation folder -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!--<Directory Id="ProgramFilesFolder">-->
        <Directory Id="INSTALLFOLDER" Name="WebView2SampleApp"/>
      <!--</Directory>-->
    </Directory>

    <!-- Step 2: Add files to your installer package -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="WebView2APISample.exe" Guid="2DC56D26-A5CC-40ED-81C5-441042F2C46B">
        <File Id="WebView2APISample.exe" Source="..\WebView2APISample\Debug\x64\WebView2APISample.exe" KeyPath="yes" Checksum="yes"/>
      </Component>
      <Component Id="WebView2Loader.dll" Guid="624B4B28-4D7F-49D8-9CAD-279FC2AC8D25">
        <File Id="WebView2Loader.dll" Source="..\WebView2APISample\Debug\x64\WebView2Loader.dll" KeyPath="yes"/>
      </Component>

      <!-- [Package Bootstrapper] Package bootstrapper with your app. Source can be anywhere you put the boostrapper on. -->
      <Component Id="MicrosoftEdgeWebview2Setup.exe" Guid="777B0F5C-51C3-4A39-AC5A-88E5A2640D48">
				<File Id="MicrosoftEdgeWebview2Setup.exe" Source="MicrosoftEdgeWebview2Setup.exe" KeyPath="yes"/>
			</Component>
    </DirectoryRef>

    <!-- Step 3: Tell WiX to install the files -->
    <Feature Id="MainApplication" Title="Main Application" Level="1" ConfigurableDirectory='INSTALLFOLDER'>
      <ComponentRef Id="WebView2APISample.exe"/>
      <ComponentRef Id="WebView2Loader.dll"/>

       <!--[Package Bootstrapper] Package bootstrapper with your app--> 
      <ComponentRef Id="MicrosoftEdgeWebview2Setup.exe" />
    </Feature>

    <!-- Step 4: Config Custom Action to download/install Bootstrapper -->
    <!-- [Package Bootstrapper] Package bootstrapper then invoke at app installation-->
    <CustomAction Id='InvokeBootstrapper' FileKey='MicrosoftEdgeWebview2Setup.exe' Execute="deferred" ExeCommand=' /install' Return='check' />

    <!-- [Download Bootstrapper] Use fwlink to download bootstrapper to user TEMP folder then invoke it-->
    <!--<CustomAction Id='DownloadAndInvokeBootstrapper' Directory="INSTALLFOLDER" Execute="deferred" Impersonate="no" ExeCommand='powershell.exe -windowstyle hidden Invoke-WebRequest -Uri "http://ie-snap/scratchtests/xiaqu/MicrosoftEdgeWebview2Setup.exe" -OutFile "$env:TEMP\MicrosoftEdgeWebview2Setup.exe" ; &amp; $env:TEMP\MicrosoftEdgeWebview2Setup.exe /install' Return='check'/>-->

    <!-- Step 5: Config execute sequence of custom action -->
    <InstallExecuteSequence>
      <!-- [Package Bootstrapper] Package bootstrapper and invoke at app installation-->
      <Custom Action='InvokeBootstrapper' Before='InstallFinalize'>
        <![CDATA[NOT(REMOVE)]]>
      </Custom>

      <!-- [Download Bootstrapper] Use fwlink to download the bootstrapper to user TEMP folder and invoke-->
      <!--<Custom Action='DownloadAndInvokeBootstrapper' Before='InstallFinalize'>
        <![CDATA[NOT(REMOVE OR WVRTINSTALLED)]]>
      </Custom>-->
    </InstallExecuteSequence>
  </Product>
</Wix>
